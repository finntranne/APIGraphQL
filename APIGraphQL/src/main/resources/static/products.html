<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Product</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">

  <h1 class="mb-4 text-primary">Quản lý Product</h1>

  <!-- Create -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">Thêm Product</div>
    <div class="card-body">
      <form id="createProdForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tiêu đề</label>
          <input type="text" id="ptitle" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Số lượng</label>
          <input type="number" id="pquantity" class="form-control">
        </div>
        <div class="col-12">
          <label class="form-label">Mô tả</label>
          <input type="text" id="pdesc" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Giá</label>
          <input type="number" id="pprice" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">UserId</label>
          <input type="number" id="puserid" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">CategoryId</label>
          <input type="number" id="pcategoryid" class="form-control">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success">Thêm</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Update -->
  <div class="card mb-4">
    <div class="card-header bg-warning">Cập nhật Product</div>
    <div class="card-body">
      <form id="updateProdForm" class="row g-3">
        <div class="col-md-2">
          <label class="form-label">ID</label>
          <input type="number" id="pid" class="form-control">
        </div>
        <div class="col-md-5">
          <label class="form-label">Tiêu đề</label>
          <input type="text" id="uptitle" class="form-control">
        </div>
        <div class="col-md-5">
          <label class="form-label">Số lượng</label>
          <input type="number" id="upquantity" class="form-control">
        </div>
        <div class="col-12">
          <label class="form-label">Mô tả</label>
          <input type="text" id="updesc" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Giá</label>
          <input type="number" id="upprice" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">UserId</label>
          <input type="number" id="upuserid" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">CategoryId</label>
          <input type="number" id="upcategoryid" class="form-control">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-warning">Cập nhật</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Filter -->
  <div class="mb-4">
    <h2>Lọc theo Category</h2>
    <div class="input-group w-25">
      <input type="number" id="filterCatId" class="form-control" placeholder="Nhập categoryId">
      <button class="btn btn-info" onclick="filterByCategory()">Lọc</button>
    </div>
  </div>

  <!-- List -->
  <h2 class="mb-3">Danh sách Product</h2>
  <button onclick="loadProducts()" class="btn btn-primary mb-3">Hiển thị (giá ↑)</button>
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>ID</th><th>Tiêu đề</th><th>Giá</th><th>Số lượng</th>
        <th>User</th><th>Category</th><th>Hành động</th>
      </tr>
    </thead>
    <tbody id="prodList"></tbody>
  </table>

  <script>
    const endpoint = "/graphql";

    // Hiển thị product theo giá ↑
    function loadProducts() {
      const query = `query {
        productsSortedByPrice { 
          id title price quantity desc 
          user { fullname } 
          categories { id name }
        }
      }`;
      fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({query})
      })
      .then(res => res.json())
      .then(res => {
        const tbody = document.getElementById("prodList");
        tbody.innerHTML = "";
        res.data.productsSortedByPrice.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.title}</td>
            <td>${p.price}đ</td>
            <td>${p.quantity}</td>
            <td>${p.user.fullname}</td>
            <td>${p.categories.map(c=>c.name).join(", ")}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">Xóa</button></td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    // Lọc theo category
    function filterByCategory() {
      const id = document.getElementById("filterCatId").value;
      const query = `query {
        productsByCategory(categoryId: ${id}) { id title price }
      }`;
      fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({query})
      })
      .then(res => res.json())
      .then(res => {
        const tbody = document.getElementById("prodList");
        tbody.innerHTML = "";
        res.data.productsByCategory.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.title}</td>
            <td>${p.price}đ</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td></td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    // Create Product
    document.getElementById("createProdForm").onsubmit = e => {
      e.preventDefault();
      const mutation = `mutation {
        createProduct(input: {
          title: "${ptitle.value}",
          quantity: ${pquantity.value},
          desc: "${pdesc.value}",
          price: ${pprice.value},
          userid: ${puserid.value},
          categoryIds: [${pcategoryid.value}]
        }) { id title }
      }`;
      fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({query: mutation})
      }).then(() => loadProducts());
    };

    // Update Product
    document.getElementById("updateProdForm").onsubmit = e => {
      e.preventDefault();
      const mutation = `mutation {
        updateProduct(id: ${pid.value}, input: {
          title: "${uptitle.value}",
          quantity: ${upquantity.value},
          desc: "${updesc.value}",
          price: ${upprice.value},
          userid: ${upuserid.value},
          categoryIds: [${upcategoryid.value}]
        }) { id title }
      }`;
      fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({query: mutation})
      }).then(() => loadProducts());
    };

    // Delete Product
    function deleteProduct(id) {
      const mutation = `mutation { deleteProduct(id: ${id}) }`;
      fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({query: mutation})
      }).then(() => loadProducts());
    }

    // Load mặc định
    loadProducts();
  </script>
</body>
</html>
